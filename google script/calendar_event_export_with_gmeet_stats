/**
 * Google Workspace Admin Tool: Calendar + Google Meet participation report
 *
 * Public / anonymized version
 *
 * What it does:
 * - Prompts for a target user email
 * - Pulls Calendar events for that user's primary calendar for the last N days
 * - Pulls Google Meet audit logs (Reports API: applicationName="meet", eventName="call_ended")
 * - Calculates time spent in meetings by matching Calendar event.id <-> Meet audit "calendar_event_id"
 *
 * Prerequisites:
 * - Apps Script: Enable Advanced Google Services:
 *   - Google Calendar API (Calendar)
 *   - Admin SDK (AdminReports)
 * - GCP project linked to the script: enable the same APIs
 *
 * Notes:
 * - Matching by Meet URL code is unreliable across domains.
 *   Using calendar_event_id is much more stable when present in audit logs.
 */

function onOpen() {
  try {
    SpreadsheetApp.getUi()
      .createMenu('ðŸ› ï¸ Admin Tools')
      .addItem('Run Calendar & Meet Report', 'runCalendarMeetReport')
      .addSeparator()
      .addItem('Debug: Sample Meet Logs (last 2 days)', 'debugMeetLogsSample')
      .addToUi();
  } catch (e) {}
}

function runCalendarMeetReport() {
  const ui = SpreadsheetApp.getUi();

  // ---- CONFIG (safe defaults) ----
  const daysBackDefault = 7;
  // -------------------------------

  const emailResp = ui.prompt(
    'Calendar & Meet report',
    'Enter target user email (primary calendar ID):',
    ui.ButtonSet.OK_CANCEL
  );
  if (emailResp.getSelectedButton() !== ui.Button.OK) return;

  const userEmail = String(emailResp.getResponseText() || '').trim();
  if (!userEmail || userEmail.indexOf('@') === -1) {
    ui.alert('Please enter a valid email address.');
    return;
  }

  const daysResp = ui.prompt(
    'Calendar & Meet report',
    `How many days back? (default: ${daysBackDefault})`,
    ui.ButtonSet.OK_CANCEL
  );
  if (daysResp.getSelectedButton() !== ui.Button.OK) return;

  const daysBackRaw = String(daysResp.getResponseText() || '').trim();
  const daysBack = daysBackRaw ? Math.max(1, Math.min(90, parseInt(daysBackRaw, 10) || daysBackDefault)) : daysBackDefault;

  const timeMin = new Date();
  timeMin.setDate(timeMin.getDate() - daysBack);
  const timeMax = new Date();

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetName = `Meet Report (${userEmail})`;
  const existing = ss.getSheetByName(sheetName);
  const sheet = existing ? existing : ss.insertSheet(sheetName);

  sheet.clear();

  const headers = [
    'Start Date',
    'Event Title',
    'RSVP Status',
    'Calendar Event ID',
    'Meet Link Code (from URL)',
    'Duration (Min)'
  ];
  sheet.appendRow(headers);
  sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#f3f3f3');

  ss.toast(`Scanning calendar + meet logs for ${userEmail}...`, 'Please Wait', -1);

  try {
    // 1) Meet durations keyed by calendar_event_id
    const durationByCalendarEventId = getMeetDurationsByCalendarEventId_(userEmail, timeMin, timeMax);

    // 2) Calendar events
    const eventsResp = Calendar.Events.list(userEmail, {
      timeMin: timeMin.toISOString(),
      timeMax: timeMax.toISOString(),
      singleEvents: true,
      orderBy: 'startTime',
      maxResults: 2500
    });

    const items = eventsResp.items || [];
    if (!items.length) {
      ss.toast('No events found for the selected time range.', 'Done', 5);
      return;
    }

    const rows = items.map(event => {
      const start = (event.start && (event.start.dateTime || event.start.date)) || '';
      const title = event.summary || 'No Title';

      // RSVP status for the target user (if present)
      let status = 'No RSVP';
      if (event.attendees && Array.isArray(event.attendees)) {
        const selfAttendee = event.attendees.find(a =>
          a && (a.self === true || (a.email && a.email.toLowerCase() === userEmail.toLowerCase()))
        );
        if (selfAttendee && selfAttendee.responseStatus) {
          status = formatStatus_(selfAttendee.responseStatus);
        }
      }

      const calEventId = event.id || '';
      const meetLinkCode = extractMeetLinkCodeFromEvent_(event) || 'N/A';

      let duration = 'No Participation / No Log';
      if (calEventId && durationByCalendarEventId[calEventId] != null) {
        duration = Number(durationByCalendarEventId[calEventId]).toFixed(2);
      }

      return [start, title, status, calEventId, meetLinkCode, duration];
    });

    sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
    sheet.autoResizeColumns(1, headers.length);

    ss.toast('Report Finished!', 'Done', 5);
  } catch (e) {
    Logger.log(String(e));
    ui.alert('Error: ' + (e && e.message ? e.message : e));
  }
}

/**
 * Extract Meet URL code from Calendar event conferenceData (for display only).
 * Typical URL: https://meet.google.com/abc-defg-hij -> returns "abcdefghij"
 */
function extractMeetLinkCodeFromEvent_(event) {
  if (!event || !event.conferenceData || !event.conferenceData.entryPoints) return '';

  const videoEntry = (event.conferenceData.entryPoints || []).find(ep =>
    ep && ep.entryPointType === 'video' && ep.uri
  );
  if (!videoEntry || !videoEntry.uri) return '';

  const last = String(videoEntry.uri).split('/').pop();
  if (!last) return '';

  return String(last).replace(/-/g, '').trim();
}

/**
 * Pull Meet "call_ended" audit logs and sum duration per calendar_event_id.
 *
 * Filtering strategy:
 * - strict: identifier==email,identifier_type==email_address
 * - fallback: identifier==email
 *
 * Returns: { [calendar_event_id]: totalMinutes }
 */
function getMeetDurationsByCalendarEventId_(email, start, end) {
  const tryFetch_ = (filters) => {
    const map = {};
    let pageToken = null;
    let totalItems = 0;

    do {
      const report = AdminReports.Activities.list('all', 'meet', {
        startTime: start.toISOString(),
        endTime: end.toISOString(),
        eventName: 'call_ended',
        filters: filters,
        pageToken: pageToken,
        maxResults: 1000
      });

      const items = report.items || [];
      totalItems += items.length;

      for (const item of items) {
        const params = item?.events?.[0]?.parameters || [];

        let calEventId = '';
        let durSeconds = 0;

        for (const p of params) {
          if (!p?.name) continue;

          if (p.name === 'calendar_event_id') {
            calEventId = String(p.value || '').trim();
          } else if (p.name === 'duration_seconds') {
            const raw = (p.intValue != null) ? p.intValue : (p.value != null ? p.value : 0);
            durSeconds = parseInt(raw, 10) || 0;
          }
        }

        if (calEventId) {
          map[calEventId] = (map[calEventId] || 0) + (durSeconds / 60);
        }
      }

      pageToken = report.nextPageToken;
    } while (pageToken);

    return { map, totalItems };
  };

  // Strict
  const strictFilters = `identifier==${email},identifier_type==email_address`;
  const res1 = tryFetch_(strictFilters);
  Logger.log(`Meet logs strict filter matched items: ${res1.totalItems}`);

  if (res1.totalItems > 0) return res1.map;

  // Loose fallback
  const looseFilters = `identifier==${email}`;
  const res2 = tryFetch_(looseFilters);
  Logger.log(`Meet logs loose filter matched items: ${res2.totalItems}`);

  return res2.map;
}

/**
 * Debug helper:
 * Pulls 5 Meet "call_ended" entries (last 2 days) without filters
 * and prints a few key parameters.
 */
function debugMeetLogsSample() {
  const start = new Date();
  start.setDate(start.getDate() - 2);
  const end = new Date();

  const report = AdminReports.Activities.list('all', 'meet', {
    startTime: start.toISOString(),
    endTime: end.toISOString(),
    eventName: 'call_ended',
    maxResults: 5
  });

  const items = report.items || [];
  Logger.log(`Sample meet call_ended items: ${items.length}`);

  items.forEach((item, idx) => {
    const params = item?.events?.[0]?.parameters || [];
    const pick = {};

    for (const p of params) {
      if (!p?.name) continue;
      if (['meeting_code', 'organizer_email', 'calendar_event_id', 'identifier', 'identifier_type', 'duration_seconds'].includes(p.name)) {
        pick[p.name] = (p.intValue != null) ? p.intValue : p.value;
      }
    }

    Logger.log(`Item #${idx + 1}: ${JSON.stringify(pick)}`);
  });
}

function formatStatus_(s) {
  const m = {
    accepted: 'Accepted',
    tentative: 'Maybe',
    declined: 'Declined',
    needsAction: 'Pending'
  };
  return m[s] || s;
}